name: Release
on:
  push:
    tags:
      - "v*"

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v3
        with:
          version: 10.28.1
      - uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml
      - name: Install
        run: pnpm install --frozen-lockfile
      - name: Verify tag matches package version
        run: |
          VERSION="v$(node -p "require('./package.json').version")"
          if [ "${GITHUB_REF_NAME}" != "${VERSION}" ]; then
            echo "Tag ${GITHUB_REF_NAME} does not match package.json version ${VERSION}"
            exit 1
          fi
      - name: Test
        run: pnpm test
      - name: Pack release artifacts
        run: |
          PACKAGE_NAME="$(node -p "require('./package.json').name.replace(/^@/, '').replace('/', '-')")"
          PACKAGE_VERSION="$(node -p "require('./package.json').version")"
          TARBALL="${PACKAGE_NAME}-${PACKAGE_VERSION}.tgz"
          pnpm pack --pack-destination .
          IS_PRERELEASE=false
          if [[ "${GITHUB_REF_NAME}" == *-* ]]; then
            IS_PRERELEASE=true
          fi
          echo "TARBALL=$TARBALL" >> "$GITHUB_ENV"
          echo "IS_PRERELEASE=$IS_PRERELEASE" >> "$GITHUB_ENV"
          sha256sum "$TARBALL" > "$TARBALL.sha256"
          if [ "$IS_PRERELEASE" = "false" ]; then
            cp "$TARBALL" typewriter.tgz
            sha256sum typewriter.tgz > typewriter.tgz.sha256
          fi
      - name: Create GitHub Release (stable)
        if: env.IS_PRERELEASE == 'false'
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          prerelease: false
          files: |
            ${{ env.TARBALL }}
            ${{ env.TARBALL }}.sha256
            typewriter.tgz
            typewriter.tgz.sha256
      - name: Create GitHub Release (prerelease)
        if: env.IS_PRERELEASE == 'true'
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          prerelease: true
          files: |
            ${{ env.TARBALL }}
            ${{ env.TARBALL }}.sha256
